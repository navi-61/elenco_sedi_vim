<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Vademecum ‚Äì Ricerca Sedi (MB) ‚Ä¢ dati.csv obbligatorio</title>
<style>
  :root{ --bg:#0b1220; --panel:#101929; --panel-2:#0e1730; --muted:#7082a8; --text:#e7ecf7; --accent:#4cc2ff; --accent-2:#8bda7c; --danger:#ff6b6b; --border:#1b2647; --chip:#0a1125; --shadow:0 6px 24px rgba(0,0,0,.35); --sidebar-w:320px; }
  html[data-theme="light"]{ --bg:#f7f9fc; --panel:#ffffff; --panel-2:#f1f5ff; --text:#0b1220; --muted:#5a6a8f; --accent:#0b6bcb; --accent-2:#137a3a; --danger:#d62828; --border:#d8e0f0; --chip:#eef4ff; --shadow:0 6px 20px rgba(14,23,48,.08) }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',Arial,'Apple Color Emoji','Segoe UI Emoji'}
  .layout{display:grid; grid-template-columns:var(--sidebar-w) 1fr; gap:16px; max-width:1200px; margin:0 auto; padding:16px}
  aside.sidebar{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); position:sticky; top:16px; align-self:start; height:max-content}
  .sidebar .title{display:flex; align-items:center; gap:8px; padding:14px 16px; border-bottom:1px solid var(--border)}
  .sidebar .title h1{font-size:1.05rem; margin:0}
  .toolbar{display:flex; gap:8px; align-items:center; background:var(--panel-2); border-top:1px solid var(--border); border-bottom:1px solid var(--border); padding:10px; flex-wrap:wrap}
  .toolbar input[type=search]{flex:1 1 200px; min-width:140px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--chip); color:var(--text)}
  .toolbar button{background:linear-gradient(180deg,#2d93ff,#1775ff); color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer}
  html[data-theme=light] .toolbar button{background:linear-gradient(180deg,#0b6bcb,#0957a6)}
  .toolbar button.secondary{background:#1f2b4a}
  html[data-theme=light] .toolbar button.secondary{background:#dae6ff;color:#0b1220}
  .toolbar .opts{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:.95rem}
  .toolbar input[type=checkbox]{width:16px;height:16px}
  .count{min-width:80px; text-align:center; background:var(--chip); border:1px solid var(--border); padding:8px 10px; border-radius:10px}
  .topbar{display:flex; gap:8px; align-items:center; justify-content:space-between; background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:10px 12px}
  .tbtn{display:inline-flex; gap:6px; align-items:center; background:#1f2b4a; color:#fff; border:none; padding:8px 12px; border-radius:10px; cursor:pointer}
  html[data-theme=light] .tbtn{background:#dae6ff;color:#0b1220}
  details{background:var(--panel); border:1px solid var(--border); border-radius:12px; margin:12px 0; overflow:hidden; box-shadow:var(--shadow)}
  summary{list-style:none; cursor:pointer; padding:14px 16px; display:flex; align-items:center; gap:10px; user-select:none}
  summary::-webkit-details-marker{display:none}
  .caret{width:1.1em; height:1.1em; transition:transform .2s ease}
  details[open] .caret{transform:rotate(90deg)}
  .content{padding:0 16px 14px}
  .filters{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
  .filters select,.filters input[type=search]{background:var(--chip); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:6px 10px}
  .filters .btn{background:#1f2b4a; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer}
  html[data-theme=light] .filters .btn{background:#dae6ff; color:#0b1220}
  .table-wrap{border:1px solid var(--border); border-radius:10px; overflow:auto; margin-top:8px}
  table{width:100%; border-collapse:collapse; min-width:860px}
  thead th{position:sticky; top:0; background:var(--panel-2); color:var(--text); border-bottom:1px solid var(--border); text-align:left; padding:10px}
  tbody td{border-bottom:1px solid var(--border); padding:8px 10px; vertical-align:top}
  tbody tr:hover{background:rgba(76,194,255,.06)}
  .alert{display:none; margin:8px 0; padding:10px 12px; border-radius:8px; border:1px solid #70323a; background:#3b1117; color:#ffd3d6}
  html[data-theme=light] .alert{border-color:#f3c4ca; background:#ffe8ea; color:#5b121d}
</style>
</head>
<body>

<div class="layout">
  <aside class="sidebar" id="sidebar">
    <div class="title"><h1>Vademecum ‚Äì Ricerca Sedi (MB)</h1></div>

    <div class="toolbar" role="search" aria-label="Ricerca nel vademecum">
      <input id="q" type="search" placeholder="Cerca‚Ä¶ (Invio: cerca / poi prossimo)" autocomplete="off" />
      <div class="opts">
        <label><input id="optCase" type="checkbox"/> match case</label>
        <label><input id="optWord" type="checkbox"/> parola intera</label>
      </div>
      <button id="btnPrev" class="secondary" title="Precedente (Shift+F3)">‚óÄ</button>
      <div id="counter" class="count" aria-live="polite">0/0</div>
      <button id="btnNext" class="secondary" title="Successivo (F3)">‚ñ∂</button>
      <button id="btnSearch" title="Evidenzia corrispondenze">Cerca</button>
      <button id="btnClear" class="secondary" title="Pulisci">Pulisci</button>
    </div>
  </aside>

  <section>
    <div class="topbar">
      <div class="left">
        <button class="tbtn sidebar-toggle" id="btnOpenSidebar" title="Apri menu">‚ò∞ Menu</button>
        <h2>Ricerca Sedi ‚Ä¢ dati.csv obbligatorio</h2>
      </div>
      <div class="right">
        <button id="btnTheme" class="tbtn" title="Tema">üåì Tema</button>
        <button id="btnPDF" class="tbtn" title="Esporta PDF">üñ®Ô∏è PDF</button>
      </div>
    </div>

    <main id="contentRoot">
      <details id="table" open>
        <summary><span class="caret">‚Ä∫</span> <h3>Tabella sedi (da dati.csv)</h3></summary>
        <div class="content">
          <div id="err" class="alert" role="alert"></div>
          <div class="filters" aria-label="Filtri">
            <select id="fCity"><option value="">‚Äî Tutte le Citt√† ‚Äî</option></select>
            <select id="fServ"><option value="">‚Äî Tutti i Servizi ‚Äî</option></select>
            <select id="fPres"><option value="">‚Äî Tutti i Presidi ‚Äî</option></select>
            <input id="fText" type="search" placeholder="Cerca testo libero‚Ä¶"/>
            <button id="btnReset" class="btn">üîÑ Reset filtri</button>
          </div>
          <div class="table-wrap">
            <table id="tbl"><thead><tr></tr></thead><tbody></tbody></table>
          </div>
          <div style="margin-top:8px; color:var(--muted)"><span id="rowsCount">0</span> righe</div>
        </div>
      </details>
    </main>
  </section>
</div>

<script>
// ‚Äî‚Äî‚Äî Tema & stampa ‚Äî‚Äî‚Äî
const LS={get(k,d){try{const v=localStorage.getItem(k);return v===null?d:JSON.parse(v)}catch{return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
function applyTheme(t){document.documentElement.setAttribute('data-theme',t)}
const storedTheme=LS.get('vm_theme',null); if(storedTheme){applyTheme(storedTheme)} else {const prefersLight=matchMedia('(prefers-color-scheme: light)').matches; applyTheme(prefersLight?'light':'dark')}
document.getElementById('btnTheme').addEventListener('click',()=>{const cur=document.documentElement.getAttribute('data-theme')||'dark'; const next=(cur==='dark')?'light':'dark'; applyTheme(next); LS.set('vm_theme',next)});
const btnPDF=document.getElementById('btnPDF'); let prevOpen=[]; function beforePrint(){prevOpen=Array.from(document.querySelectorAll('main details')).map(d=>d.open); document.querySelectorAll('main details').forEach(d=>d.open=true)} function afterPrint(){const ds=Array.from(document.querySelectorAll('main details')); ds.forEach((d,i)=>d.open=!!prevOpen[i])}
addEventListener('beforeprint', beforePrint); addEventListener('afterprint', afterPrint); btnPDF.addEventListener('click', ()=> print());

// ‚Äî‚Äî‚Äî CSV (obbligatorio) ‚Äî‚Äî‚Äî
const ERR = document.getElementById('err');
function showError(msg){ ERR.textContent = msg; ERR.style.display='block'; }
async function loadCSVStrict(){
  try{
    const resp = await fetch('dati.csv', {cache:'no-store'});
    if(!resp.ok) throw new Error('Impossibile leggere dati.csv');
    const text = await resp.text();
    if(!text.trim()) throw new Error('dati.csv √® vuoto');
    return text;
  }catch(e){
    showError('Errore: non riesco a caricare "dati.csv". Assicurati che si trovi nella stessa cartella dell\'HTML e apri il file tramite un server locale (alcuni browser bloccano il fetch da file://).');
    throw e;
  }
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  return lines.map(l=> l.split(';').map(v=>v.trim()));
}

function uniqueVals(rows, idx){ const s=new Set(); for(const r of rows){ if(r[idx]) s.add(r[idx]); } return Array.from(s).sort((a,b)=> a.localeCompare(b,'it',{sensitivity:'base'})); }
function fillSelect(sel, values){ sel.innerHTML = '<option value="">‚Äî Tutti ‚Äî</option>' + values.map(v=>`<option>${v}</option>`).join(''); }
function renderTable(head, body, rows){ head.innerHTML = rows.length? rows[0].map(h=>`<th>${h}</th>`).join('') : ''; const tb=[]; for(let i=1;i<rows.length;i++){ const r=rows[i]; if(!r.length) continue; tb.push('<tr>'+ r.map(c=>`<td>${c||''}</td>`).join('') + '</tr>'); } body.innerHTML=tb.join(''); document.getElementById('rowsCount').textContent=Math.max(0, rows.length-1); }
function applyFilters(rows){ const city=fCity.value.toLowerCase(), serv=fServ.value.toLowerCase(), pres=fPres.value.toLowerCase(), text=fText.value.toLowerCase(); const out=[rows[0]]; for(let i=1;i<rows.length;i++){ const r=rows[i]; if(!r.length) continue; const ok=(city? (r[0]||'').toLowerCase().includes(city):true) && (serv? (r[2]||'').toLowerCase().includes(serv):true) && (pres? (r[4]||'').toLowerCase().includes(pres):true) && (text? r.join(' ').toLowerCase().includes(text):true); if(ok) out.push(r); } return out; }

const fCity=document.getElementById('fCity'), fServ=document.getElementById('fServ'), fPres=document.getElementById('fPres'), fText=document.getElementById('fText');
(async function init(){
  try{
    const raw = await loadCSVStrict();
    const rows = parseCSV(raw);
    if(!rows.length){ showError('dati.csv non contiene righe.'); return; }
    fillSelect(fCity, uniqueVals(rows.slice(1),0));
    fillSelect(fServ, uniqueVals(rows.slice(1),2));
    fillSelect(fPres, uniqueVals(rows.slice(1),4));
    const headRow = document.querySelector('#tbl thead tr');
    const body    = document.querySelector('#tbl tbody');
    renderTable(headRow, body, rows);
    const applyAndRender = ()=>{ renderTable(headRow, body, applyFilters(rows)); };
    fCity.addEventListener('change', applyAndRender);
    fServ.addEventListener('change', applyAndRender);
    fPres.addEventListener('change', applyAndRender);
    fText.addEventListener('input', applyAndRender);
    document.getElementById('btnReset').addEventListener('click', ()=>{ ['fCity','fServ','fPres','fText'].forEach(id=> document.getElementById(id).value=''); renderTable(headRow, body, rows); });
  }catch(e){ console.warn(e); }
})();
</script>
</body>
</html>