<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Filtro Sedi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: white; color: #333; padding: 20px; }
  select { font-size: 14px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; }
  .dark-mode { background: #121212; color: #eee; }
  .dark-mode .tooltip .tooltiptext { background-color: #333; color: #eee; border: 1px solid #555; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { font-size: 14px; padding: 6px 10px; border: 1px solid #ccc; text-align: left; }
  th { cursor: pointer; background-color: #f2f2f2; }
  .tooltip { position: relative; display: inline-block; cursor: help; }
  .tooltip .tooltiptext {
    visibility: hidden; width: max-content; max-width: 300px; background-color: #fff8c4; color: #333;
    text-align: left; padding: 5px; border: 1px solid #ccc; border-radius: 4px; position: absolute;
    z-index: 1; top: 100%; left: 0; white-space: normal; opacity: 0; transition: opacity 0.3s;
  }
  .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
  .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  button, select { font-size: 12px; padding: 8px; }
  .pagination { margin-top: 10px; }
  .pagination button { margin-right: 5px; padding: 5px 10px; }
  mark, .highlight { background: yellow; color: black; }
</style>
</head>
<body>
<h2>ELENCO SEDI</h2>

<input type="text" id="searchBox" placeholder="🔍 Cerca..." style="margin-bottom:10px; padding:5px; width:200px;">
<button onclick="resetFiltro()">Reset filtro</button>

<div class="controls">
  <select id="cityFilter"><option value="">-- Tutte le Città --</option></select>
  <select id="serviceFilter"><option value="">-- Tutti i Servizi --</option></select>
  <select id="presidioFilter"><option value="">-- Tutti i Presidi --</option></select>
  <button onclick="resetFilters()">🔄 Reset filtri</button>
  <button onclick="generatePDF()">📄 Esporta PDF</button>
  <button onclick="toggleDarkMode()">🌓 Tema chiaro/scuro</button>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th onclick="sortTable(0)">Città</th>
      <th onclick="sortTable(1)">Indirizzo</th>
      <th onclick="sortTable(2)">Servizio ASST</th>
      <th onclick="sortTable(3)">Email SIA</th>
      <th onclick="sortTable(4)">Presidio Fleet</th>
      <th onclick="sortTable(5)">Note</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pagination" id="pagination"></div>

<script>
let rows = [];
const pageSize = 20;
let currentPage = 1;
let sortAsc = true;
let currentSortIndex = null;

const tbody = document.querySelector('#dataTable tbody');
const pagination = document.getElementById('pagination');

const emailMap = {
  'CARATE': 'sia.carate@asst-brianza.it',
  'VIMERCATE': 'sia.vimercate@asst-brianza.it',
  'DESIO': 'sia.desio@asst-brianza.it',
  'IRCCS MONZA': 'riferire a fleet monza'
};

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
}

function highlightMatch(text, searchTerms) {
  let result = text;
  searchTerms.forEach(term => {
    if (term) {
      const regex = new RegExp(`(${term.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
      result = result.replace(regex, '<span class="highlight">$1</span>');
    }
  });
  return result;
}

async function loadCSV() {
  try {
    const response = await fetch('dati.csv');
    if(!response.ok) throw new Error('Errore caricamento CSV: ' + response.statusText);
    const text = await response.text();
    parseCSV(text);
    populateFilters();
    renderTable();
  } catch(err) {
    alert(err.message);
  }
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  rows = lines.slice(1).map(line => {
    const values = line.split(';').map(v => v.trim());
    return {
      citta: values[0] || '',
      indirizzo: values[1] || '',
      servizio: values[2] || '',
      email: values[3] || '',
      presidio: values[4] || '',
      note: values[5] || ''
    };
  });
}

function populateFilters() {
  const cityFilter = document.getElementById('cityFilter');
  const serviceFilter = document.getElementById('serviceFilter');
  const presidioFilter = document.getElementById('presidioFilter');

  cityFilter.options.length = 1;
  serviceFilter.options.length = 1;
  presidioFilter.options.length = 1;

  const cities = [...new Set(rows.map(r => r.citta))].filter(Boolean).sort();
  const services = [...new Set(rows.map(r => r.servizio))].filter(Boolean).sort();
  const presidi = [...new Set(rows.map(r => r.presidio))].filter(Boolean).sort();

  cities.forEach(value => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = value;
    cityFilter.appendChild(option);
  });

  services.forEach(value => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = value;
    serviceFilter.appendChild(option);
  });

  presidi.forEach(value => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = value;
    presidioFilter.appendChild(option);
  });
}

/* function filterRows() {
  const cityVal = document.getElementById('cityFilter').value.trim().toLowerCase();
  const serviceVal = document.getElementById('serviceFilter').value.trim().toLowerCase();
  const presidioVal = document.getElementById('presidioFilter').value.trim().toLowerCase();
  const searchTerm = document.getElementById('searchBox').value.trim().toLowerCase();

  return rows.filter(row => {
    const citta = (row.citta || '').toLowerCase();
    const servizio = (row.servizio || '').toLowerCase();
    const presidio = (row.presidio || '').toLowerCase();

    const matchesFilter = 
      (!cityVal || citta.includes(cityVal)) &&
      (!serviceVal || servizio.includes(serviceVal)) &&
      (!presidioVal || presidio.includes(presidioVal));

    const matchesSearch = !searchTerm || Object.values(row).some(v => (v || '').toLowerCase().includes(searchTerm));

    return matchesFilter && matchesSearch;
  });
}*/
  function filterRows() {
  const cityVal = document.getElementById('cityFilter').value.trim().toLowerCase();
  const serviceVal = document.getElementById('serviceFilter').value.trim().toLowerCase();
  const presidioVal = document.getElementById('presidioFilter').value.trim().toLowerCase();
  const searchTerm = document.getElementById('searchBox').value.trim().toLowerCase();

  return rows.filter(row => {
    // Controlla filtri dropdown
    if (cityVal && !row.citta.toLowerCase().includes(cityVal)) return false;
    if (serviceVal && !row.servizio.toLowerCase().includes(serviceVal)) return false;
    if (presidioVal && !row.presidio.toLowerCase().includes(presidioVal)) return false;

    // Controlla ricerca libera su TUTTI i campi
    if (searchTerm) {
      const haystack = Object.values(row).join(' ').toLowerCase();
      return haystack.includes(searchTerm);
    }

    return true;
  });
}


/*function renderTable() {
  tbody.innerHTML = '';

  const searchValue = document.getElementById('searchBox').value.toLowerCase().trim();
  const searchTerms = searchValue.split(/\s+/).filter(term => term);

  let filtered = filterRows();

  if (currentSortIndex !== null) {
    const keys = ['citta', 'indirizzo', 'servizio', 'email', 'presidio', 'note'];
    const key = keys[currentSortIndex];
     // filtered.sort((a, b) => {
    //  filtered.sort((a, b) => a.citta.localeCompare(b.citta));
    /* filtered.sort((a, b) => {
      const aCitta = (a.citta || '').toLowerCase();
      const bCitta = (b.citta || '').toLowerCase();
      return aCitta.localeCompare(bCitta);
    });
    /*
      let valA = (a[key] || '').toLowerCase();
      let valB = (b[key] || '').toLowerCase();
      if (valA < valB) return sortAsc ? -1 : 1;
      if (valA > valB) return sortAsc ? 1 : -1;
      return 0;
    });
  }

  const totalPages = Math.ceil(filtered.length / pageSize);
  if (currentPage > totalPages) currentPage = totalPages || 1;

  const start = (currentPage - 1) * pageSize;
  const pageRows = filtered.slice(start, start + pageSize);

  if (pageRows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nessun risultato</td></tr>';
    pagination.innerHTML = '';
    return;
  }

  for (const row of pageRows) {
    const presidioUpper = row.presidio.toUpperCase();
    const tooltipEmail = emailMap[presidioUpper] || '';
    const emailRaw = row.email.trim();
    let emailHtml = '';

    if (emailRaw.includes('@')) {
      emailHtml = highlightMatch(escapeHtml(emailRaw), searchTerms);
    } else if (!emailRaw && tooltipEmail) {
      emailHtml = `<div class="tooltip">${escapeHtml(row.presidio || '')}
        <span class="tooltiptext">${escapeHtml(tooltipEmail)}</span></div>`;
    } else if (emailMap[emailRaw.toUpperCase()]) {
      emailHtml = `<div class="tooltip">${escapeHtml(emailRaw || '')}
        <span class="tooltiptext">${escapeHtml(emailMap[emailRaw.toUpperCase()])}</span></div>`;
    } else {
      emailHtml = highlightMatch(escapeHtml(emailRaw), searchTerms);
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${highlightMatch(escapeHtml(row.citta || ''), searchTerms)}</td>
      <td>${highlightMatch(escapeHtml(row.indirizzo || ''), searchTerms)}</td>
      <td><div class="tooltip">${highlightMatch(escapeHtml(row.servizio || ''), searchTerms)}
        <span class="tooltiptext">${escapeHtml(row.servizio || '')}</span></div></td>
      <td>${emailHtml}</td>
      <td>${highlightMatch(escapeHtml(row.presidio || ''), searchTerms)}</td>
      <td><div class="tooltip">${highlightMatch(escapeHtml(row.note || ''), searchTerms)}
        <span class="tooltiptext">${escapeHtml(row.note || '')}</span></div></td>
    `;
    tbody.appendChild(tr);
  }

  renderPagination(totalPages);
}*/

  function renderTable() {
  const tbody = document.querySelector('#dataTable tbody');
  const searchValue = document.getElementById('searchBox').value.toLowerCase().trim();
  const searchTerms = searchValue.split(/\s+/).filter(term => term); // separa in parole

  // Filtra righe con i filtri e ricerca
  let filtered = filterRows();

  // Ordina per citta in modo sicuro
  filtered.sort((a, b) => {
    const aCitta = (a.citta || '').toLowerCase();
    const bCitta = (b.citta || '').toLowerCase();
    return aCitta.localeCompare(bCitta);
  });

  // Calcola pagine
  const totalPages = Math.ceil(filtered.length / pageSize);
  if (currentPage > totalPages) currentPage = totalPages || 1;

  // Sottoseleziona dati da mostrare in pagina
  const start = (currentPage - 1) * pageSize;
  const pageRows = filtered.slice(start, start + pageSize);

  tbody.innerHTML = '';

  if (pageRows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nessun risultato</td></tr>';
    pagination.innerHTML = '';
    return;
  }

  // Funzione per evidenziare testo ricercato
  function highlightMatch(text, searchTerms) {
    let result = escapeHtml(text || '');
    searchTerms.forEach(term => {
      if (term) {
        const regex = new RegExp(`(${term})`, 'gi');
        result = result.replace(regex, '<mark>$1</mark>');
      }
    });
    return result;
  }

  // Render righe
  for (const row of pageRows) {
    const presidioUpper = (row.presidio || '').toUpperCase();
    const tooltipEmail = emailMap[presidioUpper] || '';

    const emailRaw = (row.email || '').trim();
    let emailHtml = '';

    if (emailRaw.includes('@')) {
      emailHtml = highlightMatch(emailRaw, searchTerms);
    } else if (!emailRaw && tooltipEmail) {
      emailHtml = `<div class="tooltip">${highlightMatch(row.presidio, searchTerms)}
                   <span class="tooltiptext">${escapeHtml(tooltipEmail)}</span></div>`;
    } else if (emailMap[emailRaw.toUpperCase()]) {
      emailHtml = `<div class="tooltip">${highlightMatch(emailRaw, searchTerms)}
                   <span class="tooltiptext">${escapeHtml(emailMap[emailRaw.toUpperCase()])}</span></div>`;
    } else {
      emailHtml = highlightMatch(emailRaw, searchTerms);
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${highlightMatch(row.citta, searchTerms)}</td>
      <td>${highlightMatch(row.indirizzo, searchTerms)}</td>
      <td><div class="tooltip">${highlightMatch(row.servizio, searchTerms)}
        <span class="tooltiptext">${escapeHtml(row.servizio)}</span></div></td>
      <td>${emailHtml}</td>
      <td>${highlightMatch(row.presidio, searchTerms)}</td>
      <td><div class="tooltip">${highlightMatch(row.note, searchTerms)}
        <span class="tooltiptext">${escapeHtml(row.note)}</span></div></td>
    `;
    tbody.appendChild(tr);
  }

  // Render paginazione
  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  pagination.innerHTML = '';
  if(totalPages <= 1) return;
  for(let i=1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if(i === currentPage) btn.disabled = true;
    btn.addEventListener('click', () => { currentPage = i; renderTable(); });
    pagination.appendChild(btn);
  }
}

function resetFiltro() {
  document.getElementById('searchBox').value = '';
  resetFilters();
}

function resetFilters() {
  document.getElementById('cityFilter').value = '';
  document.getElementById('serviceFilter').value = '';
  document.getElementById('presidioFilter').value = '';
  currentPage = 1;
  currentSortIndex = null;
  sortAsc = true;
  renderTable();
}

function sortTable(index) {
  if(currentSortIndex === index) sortAsc = !sortAsc;
  else { currentSortIndex = index; sortAsc = true; }
  renderTable();
}

function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Elenco Sedi", 14, 15);

  const filtered = filterRows();
  if(filtered.length === 0) { alert("Nessun dato da esportare."); return; }

  const headers = ["Città", "Indirizzo", "Servizio ASST", "Email", "Presidio Fleet", "Note"];
  const pdfData = filtered.map(row => {
    let emailKey = row.email.trim().toUpperCase();
    let emailFull = emailMap[emailKey] || row.email;
    return [row.citta, row.indirizzo, row.servizio, emailFull, row.presidio, row.note];
  });

  doc.autoTable({
    head: [headers],
    body: pdfData,
    startY: 25,
    styles: { fontSize: 8 }
  });
  doc.save("elenco_sedi.pdf");
}

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

document.getElementById('searchBox').addEventListener('input', () => { currentPage = 1; renderTable(); });
document.getElementById('cityFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
document.getElementById('serviceFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
document.getElementById('presidioFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });

loadCSV();
</script>
</body>
</html>





