<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Filtro Sedi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: white; color: #333; padding: 20px; }
  select { font-size: 14px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; }
  .dark-mode { background: #121212; color: #eee; }
  .dark-mode .tooltip .tooltiptext { background-color: #333; color: #eee; border: 1px solid #555; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { font-size: 14px; padding: 6px 10px; border: 1px solid #ccc; text-align: left; }
  th { cursor: pointer; background-color: #f2f2f2; }
  .tooltip { position: relative; display: inline-block; cursor: help; }
  .tooltip .tooltiptext {
    visibility: hidden; width: max-content; max-width: 300px; background-color: #fff8c4; color: #333;
    text-align: left; padding: 5px; border: 1px solid #ccc; border-radius: 4px; position: absolute;
    z-index: 1; top: 100%; left: 0; white-space: normal; opacity: 0; transition: opacity 0.3s;
  }
  .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
  .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  button, select { font-size: 12px; padding: 8px; }
  .pagination { margin-top: 10px; }
  .pagination button { margin-right: 5px; padding: 5px 10px; }
  mark { background: yellow; color: black; }
</style>
</head>
<body>
<h2>ELENCO SEDI</h2>

<input type="text" id="searchBox" placeholder="ðŸ” Cerca..." style="margin-bottom:10px; padding:5px; width:200px;">
<button onclick="resetFiltro()">Reset filtro</button>

<div class="controls">
  <select id="cityFilter"><option value="">-- Tutte le CittÃ  --</option></select>
  <select id="serviceFilter"><option value="">-- Tutti i Servizi --</option></select>
  <select id="presidioFilter"><option value="">-- Tutti i Presidi --</option></select>
  <button onclick="resetFilters()">ðŸ”„ Reset filtri</button>
  <button onclick="generatePDF()">ðŸ“„ Esporta PDF</button>
  <button onclick="toggleDarkMode()">ðŸŒ“ Tema chiaro/scuro</button>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th onclick="sortTable(0)">CittÃ </th>
      <th onclick="sortTable(1)">Indirizzo</th>
      <th onclick="sortTable(2)">Servizio ASST</th>
      <th onclick="sortTable(3)">Email SIA</th>
      <th onclick="sortTable(4)">Presidio Fleet</th>
      <th onclick="sortTable(5)">Note</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pagination" id="pagination"></div>

<script>
let rows = [];
const pageSize = 20;
let currentPage = 1;
let sortAsc = true;
let currentSortIndex = null;

const tbody = document.querySelector('#dataTable tbody');
const pagination = document.getElementById('pagination');

// Mappa email per presidio
const emailMap = {
  'CARATE': 'sia.carate@asst-brianza.it',
  'VIMERCATE': 'sia.vimercate@asst-brianza.it',
  'DESIO': 'sia.desio@asst-brianza.it',
  'IRCCS MONZA': 'riferire a fleet monza'
};

// Escape HTML
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
}

// Evidenzia testo
function highlightMatch(text, searchTerms) {
    let result = text;
    searchTerms.forEach(term => {
        if (term) {
            const regex = new RegExp(`(${term})`, 'gi');
            result = result.replace(regex, '<span class="highlight">$1</span>');
        }
    });
    return result;
}

// Carica CSV
async function loadCSV() {
  try {
    const response = await fetch('dati.csv');
    if(!response.ok) throw new Error('Errore caricamento CSV: ' + response.statusText);
    const text = await response.text();
    parseCSV(text);
    populateFilters();
    renderTable();
  } catch(err) {
    alert(err.message);
  }
}

// Parsing CSV
function parseCSV(text) {
  const lines = text.trim().split('\n');
  rows = lines.slice(1).map(line => {
    const values = line.split(';').map(v => v.trim());
    return {
      citta: values[0] || '',
      indirizzo: values[1] || '',
      servizio: values[2] || '',
      email: values[3] || '',
      presidio: values[4] || '',
      note: values[5] || ''
    };
  });
}

// Popola filtri
function populateFilters() {
  const cityFilter = document.getElementById('cityFilter');
  const serviceFilter = document.getElementById('serviceFilter');
  const presidioFilter = document.getElementById('presidioFilter');

  cityFilter.options.length = 1;
  serviceFilter.options.length = 1;
  presidioFilter.options.length = 1;

  const cities = [...new Set(rows.map(r => r.citta))].filter(Boolean).sort();
  const services = [...new Set(rows.map(r => r.servizio))].filter(Boolean).sort();
  const presidi = [...new Set(rows.map(r => r.presidio))].filter(Boolean).sort();

  for (const list of [cities, services, presidi]) {
    list.forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      if (list === cities) cityFilter.appendChild(option);
      else if (list === services) serviceFilter.appendChild(option);
      else presidioFilter.appendChild(option);
    });
  }
}

// Filtra righe
function filterRows() {
  const cityVal = document.getElementById('cityFilter').value;
  const serviceVal = document.getElementById('serviceFilter').value;
  const presidioVal = document.getElementById('presidioFilter').value;
  const searchTerm = document.getElementById('searchBox').value.trim().toLowerCase();

  return rows.filter(row => {
    const matchesFilter = (!cityVal || row.citta === cityVal) &&
                          (!serviceVal || row.servizio === serviceVal) &&
                          (!presidioVal || row.presidio === presidioVal);
    const matchesSearch = !searchTerm || Object.values(row).some(v => (v || '').toLowerCase().includes(searchTerm));
    return matchesFilter && matchesSearch;
  });
}

// Render tabella
function renderTable() {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    const searchValue = document.getElementById('searchBox').value.toLowerCase().trim();
    const searchTerms = searchValue.split(/\s+/).filter(term => term); // separa in parole

    const filteredData = filterRows(data).filter(row => {
        return searchTerms.every(term =>
            row.some(cell => cell.toLowerCase().includes(term))
        );
    });

    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    document.getElementById('pageInfo').textContent = `Pagina ${currentPage} di ${totalPages || 1}`;

    const start = (currentPage - 1) * rowsPerPage;
    const pageData = filteredData.slice(start, start + rowsPerPage);

    pageData.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
            const td = document.createElement('td');
            td.innerHTML = highlightMatch(cell, searchTerms); // evidenzia multiparola
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
  }

  const totalPages = Math.ceil(filtered.length / pageSize);
  if(currentPage > totalPages) currentPage = totalPages || 1;

  const pageRows = filtered.slice((currentPage -1)*pageSize, currentPage*pageSize);
  tbody.innerHTML = '';

  if(pageRows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nessun risultato</td></tr>';
    pagination.innerHTML = '';
    return;
  }

  for (const row of pageRows) {
    const presidioUpper = row.presidio.toUpperCase();
    const tooltipEmail = emailMap[presidioUpper] || '';

    const emailRaw = row.email.trim();
    let emailHtml = '';

    if (emailRaw.includes('@')) {
      emailHtml = highlightMatch(escapeHtml(emailRaw), searchTerm);
    } else if (!emailRaw && tooltipEmail) {
      emailHtml = `<div class="tooltip">${highlightMatch(escapeHtml(row.presidio || ''), searchTerm)}
                    <span class="tooltiptext">${escapeHtml(tooltipEmail)}</span></div>`;
    } else if (emailMap[emailRaw.toUpperCase()]) {
      emailHtml = `<div class="tooltip">${highlightMatch(escapeHtml(emailRaw || ''), searchTerm)}
                    <span class="tooltiptext">${escapeHtml(emailMap[emailRaw.toUpperCase()])}</span></div>`;
    } else {
      emailHtml = highlightMatch(escapeHtml(emailRaw), searchTerm);
    }

    let tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${highlightMatch(escapeHtml(row.citta || ''), searchTerm)}</td>
      <td>${highlightMatch(escapeHtml(row.indirizzo || ''), searchTerm)}</td>
      <td><div class="tooltip">${highlightMatch(escapeHtml(row.servizio || ''), searchTerm)}
        <span class="tooltiptext">${escapeHtml(row.servizio || '')}</span></div></td>
      <td>${emailHtml}</td>
      <td>${highlightMatch(escapeHtml(row.presidio || ''), searchTerm)}</td>
      <td><div class="tooltip">${highlightMatch(escapeHtml(row.note || ''), searchTerm)}
        <span class="tooltiptext">${escapeHtml(row.note || '')}</span></div></td>
    `;
    tbody.appendChild(tr);
  }

  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  pagination.innerHTML = '';
  if(totalPages <= 1) return;
  for(let i=1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if(i === currentPage) btn.disabled = true;
    btn.addEventListener('click', () => { currentPage = i; renderTable(); });
    pagination.appendChild(btn);
  }
}

function resetFiltro() {
  document.getElementById('searchBox').value = '';
  resetFilters();
}

function resetFilters() {
  document.getElementById('cityFilter').value = '';
  document.getElementById('serviceFilter').value = '';
  document.getElementById('presidioFilter').value = '';
  currentPage = 1;
  currentSortIndex = null;
  sortAsc = true;
  renderTable();
}

function sortTable(index) {
  if(currentSortIndex === index) sortAsc = !sortAsc;
  else { currentSortIndex = index; sortAsc = true; }
  renderTable();
}

function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Elenco Sedi", 14, 15);

  const filtered = filterRows();
  if(filtered.length === 0) { alert("Nessun dato da esportare."); return; }

  const headers = ["CittÃ ", "Indirizzo", "Servizio ASST", "Email", "Presidio Fleet", "Note"];
  const pdfData = filtered.map(row => {
    let emailKey = row.email.trim().toUpperCase();
    let emailFull = emailMap[emailKey] || row.email;
    return [row.citta, row.indirizzo, row.servizio, emailFull, row.presidio, row.note];
  });

  doc.autoTable({
    head: [headers],
    body: pdfData,
    startY: 25,
    styles: { fontSize: 8 }
  });
  doc.save("elenco_sedi.pdf");
}

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

// Event listeners
document.getElementById('searchBox').addEventListener('input', () => { currentPage = 1; renderTable(); });
document.getElementById('cityFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
document.getElementById('serviceFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
document.getElementById('presidioFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });

// Carica dati
loadCSV();
</script>
</body>
</html>

