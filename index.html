<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Filtro Sedi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: white; color: #333; padding: 20px; }
    select { font-size: 14px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; }
    .dark-mode { background: #121212; color: #eee; }
    .dark-mode .tooltip .tooltiptext { background-color: #333; color: #eee; border: 1px solid #555; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { font-size: 14px; padding: 6px 10px; border: 1px solid #ccc; text-align: left; }
    th { cursor: pointer; background-color: #f2f2f2; }
    .tooltip { position: relative; display: inline-block; cursor: help; }
    .tooltip .tooltiptext {
      visibility: hidden; width: max-content; max-width: 300px; background-color: #fff8c4; color: #333;
      text-align: left; padding: 5px; border: 1px solid #ccc; border-radius: 4px; position: absolute;
      z-index: 1; top: 100%; left: 0; white-space: normal; opacity: 0; transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    button, select { font-size: 12px; padding: 8px; }
    .pagination { margin-top: 10px; }
    .pagination button { margin-right: 5px; padding: 5px 10px; }
    mark { background: yellow; color: black; }
  </style>
</head>
<body>
  <h2>ELENCO SEDI</h2>

  <input type="text" id="searchBox" placeholder="ðŸ” Cerca..." style="margin-bottom:10px; padding:5px; width:200px;">
  <button onclick="resetFiltro()">Reset filtro</button>
	
  <div class="controls">
    <select id="cityFilter"><option value="">-- Tutte le CittÃ  --</option></select>
    <select id="serviceFilter"><option value="">-- Tutti i Servizi --</option></select>
    <select id="presidioFilter"><option value="">-- Tutti i Presidi --</option></select>
    <button onclick="resetFilters()">ðŸ”„ Reset filtri</button>
    <button onclick="generatePDF()">ðŸ“„ Esporta PDF</button>
    <button onclick="toggleDarkMode()">ðŸŒ“ Tema chiaro/scuro</button>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">CittÃ </th>
        <th onclick="sortTable(1)">Indirizzo</th>
        <th onclick="sortTable(2)">Servizio ASST</th>
        <th onclick="sortTable(3)">Email SIA</th>
        <th onclick="sortTable(4)">Presidio Fleet</th>
        <th onclick="sortTable(5)">Note</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>

  <script>
    let rows = [];
    const pageSize = 20;
    let currentPage = 1;
    let sortAsc = true;
    let currentSortIndex = null;

    const tbody = document.querySelector('#dataTable tbody');
    const pagination = document.getElementById('pagination');

    // Mappa email per presidio (chiave maiuscola)
    const emailMap = {
      'CARATE': 'sia.carate@asst-brianza.it',
      'VIMERCATE': 'sia.vimercate@asst-brianza.it',
      'DESIO': 'sia.desio@asst-brianza.it',
      'IRCCS MONZA': 'riferire a fleet monza'
    };

    // Helper per escape HTML (sicurezza) e highlight
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    function highlightMatch(text, term) {
      if (!term) return text;
      // term already normalized to lower; build regex with escaped term
      const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${esc})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    // Search box -> re-render table (single listener)
    document.getElementById('searchBox').addEventListener('input', () => {
      currentPage = 1;
      renderTable();
    });

    // Funzione per caricare e parsare CSV
    async function loadCSV() {
      try {
        const response = await fetch('dati.csv');
        if(!response.ok) throw new Error('Errore caricamento CSV: ' + response.statusText);
        const text = await response.text();
        parseCSV(text);
        populateFilters();
        renderTable();
      } catch(err) {
        alert(err.message);
      }
    }
	document.getElementById('searchBox').addEventListener('input', function () {
		filtraETrova(this.value);
	});
	function filtraETrova(term) {
    term = term.toLowerCase();
    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
        let match = false;
        [...row.cells].forEach(cell => {
            const text = cell.textContent;
            if (term && text.toLowerCase().includes(term)) {
                match = true;
                const regex = new RegExp(`(${term})`, "gi");
                cell.innerHTML = text.replace(regex, "<mark>$1</mark>");
            } else {
                cell.innerHTML = text;
            }
        });
        row.style.display = match || !term ? '' : 'none';
    });
}

function resetFiltro() {
    document.getElementById('searchBox').value = '';
    loadCSV(); // ricarica dati senza evidenziazione
    // Parse CSV semplice (header e ; come separatore)
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(';').map(h => h.trim());
      rows = lines.slice(1).map(line => {
        const values = line.split(';').map(v => v.trim());
        return {
          citta: values[0] || '',
          indirizzo: values[1] || '',
          servizio: values[2] || '',
          email: values[3] || '',
          presidio: values[4] || '',
          note: values[5] || ''
        };
      });
    }

    function populateFilters() {
      const cityFilter = document.getElementById('cityFilter');
      const serviceFilter = document.getElementById('serviceFilter');
      const presidioFilter = document.getElementById('presidioFilter');

      cityFilter.options.length = 1;
      serviceFilter.options.length = 1;
      presidioFilter.options.length = 1;

      const cities = Array.from(new Set(rows.map(r => r.citta))).filter(c => c).sort();
      const services = Array.from(new Set(rows.map(r => r.servizio))).filter(s => s).sort();
      const presidi = Array.from(new Set(rows.map(r => r.presidio))).filter(p => p).sort();

      for (const city of cities) {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        cityFilter.appendChild(option);
      }
      for (const serv of services) {
        const option = document.createElement('option');
        option.value = serv;
        option.textContent = serv;
        serviceFilter.appendChild(option);
      }
      for (const pres of presidi) {
        const option = document.createElement('option');
        option.value = pres;
        option.textContent = pres;
        presidioFilter.appendChild(option);
      }
    }

    function filterRows() {
      const cityVal = document.getElementById('cityFilter').value;
      const serviceVal = document.getElementById('serviceFilter').value;
      const presidioVal = document.getElementById('presidioFilter').value;

      return rows.filter(row => {
        return (!cityVal || row.citta === cityVal) &&
               (!serviceVal || row.servizio === serviceVal) &&
               (!presidioVal || row.presidio === presidioVal);
      });
    }

    function renderTable() {
      // prendo prima i risultati dei filtri a tendina
      let filtered = filterRows();

      // applico la ricerca testuale (caso-insensitiva) sui valori della riga
      const searchTerm = document.getElementById('searchBox').value.trim().toLowerCase();
      if (searchTerm) {
        filtered = filtered.filter(r => {
          return Object.values(r).some(v => (v || '').toLowerCase().includes(searchTerm));
        });
      }

      // ordinamento (se impostato)
      if (currentSortIndex !== null) {
        filtered.sort((a, b) => {
          let valA, valB;
          switch(currentSortIndex) {
            case 0: valA = a.citta.toLowerCase(); valB = b.citta.toLowerCase(); break;
            case 1: valA = a.indirizzo.toLowerCase(); valB = b.indirizzo.toLowerCase(); break;
            case 2: valA = a.servizio.toLowerCase(); valB = b.servizio.toLowerCase(); break;
            case 3: valA = a.email.toLowerCase(); valB = b.email.toLowerCase(); break;
            case 4: valA = a.presidio.toLowerCase(); valB = b.presidio.toLowerCase(); break;
            case 5: valA = a.note.toLowerCase(); valB = b.note.toLowerCase(); break;
            default: valA = ''; valB = '';
          }
          if(valA < valB) return sortAsc ? -1 : 1;
          if(valA > valB) return sortAsc ? 1 : -1;
          return 0;
        });
      }

      const totalPages = Math.ceil(filtered.length / pageSize);
      if(currentPage > totalPages) currentPage = totalPages || 1;

      const pageRows = filtered.slice((currentPage -1)*pageSize, currentPage*pageSize);

      tbody.innerHTML = '';

      if(pageRows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nessun risultato</td></tr>';
        pagination.innerHTML = '';
        return;
      }

      for (const row of pageRows) {
        const presidioUpper = row.presidio.toUpperCase();
        const tooltipEmail = emailMap[presidioUpper] || '';

        const emailRaw = row.email.trim();
        let emailHtml = '';

        if (emailRaw.includes('@')) {
          emailHtml = highlightMatch(escapeHtml(emailRaw), searchTerm);
        } else if (emailRaw === '' && tooltipEmail) {
          emailHtml = `<div class="tooltip">${highlightMatch(escapeHtml(row.presidio || ''), searchTerm)}
                        <span class="tooltiptext">${escapeHtml(tooltipEmail)}</span></div>`;
        } else if (emailMap[emailRaw.toUpperCase()]) {
          emailHtml = `<div class="tooltip">${highlightMatch(escapeHtml(emailRaw || ''), searchTerm)}
                        <span class="tooltiptext">${escapeHtml(emailMap[emailRaw.toUpperCase()])}</span></div>`;
        } else {
          emailHtml = highlightMatch(escapeHtml(emailRaw), searchTerm);
        }

        const cittaHtml = highlightMatch(escapeHtml(row.citta || ''), searchTerm);
        const indirizzoHtml = highlightMatch(escapeHtml(row.indirizzo || ''), searchTerm);
        const servizioHtml = highlightMatch(escapeHtml(row.servizio || ''), searchTerm);
        const presidioHtml = highlightMatch(escapeHtml(row.presidio || ''), searchTerm);
        const noteHtml = highlightMatch(escapeHtml(row.note || ''), searchTerm);

        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${cittaHtml}</td>
          <td>${indirizzoHtml}</td>
          <td>
            <div class="tooltip">${servizioHtml}
              <span class="tooltiptext">${escapeHtml(row.servizio || '')}</span>
            </div>
          </td>
          <td>${emailHtml}</td>
          <td>${presidioHtml}</td>
          <td>
            <div class="tooltip">${noteHtml}
              <span class="tooltiptext">${escapeHtml(row.note || '')}</span>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      pagination.innerHTML = '';
      if(totalPages <= 1) return;
      for(let i=1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if(i === currentPage) btn.disabled = true;
        btn.addEventListener('click', () => {
          currentPage = i;
          renderTable();
        });
        pagination.appendChild(btn);
      }
    }

    function resetFilters() {
      document.getElementById('cityFilter').value = '';
      document.getElementById('serviceFilter').value = '';
      document.getElementById('presidioFilter').value = '';
      currentPage = 1;
      currentSortIndex = null;
      sortAsc = true;
      renderTable();
    }

    function sortTable(index) {
      if(currentSortIndex === index) {
        sortAsc = !sortAsc;
      } else {
        currentSortIndex = index;
        sortAsc = true;
      }
      renderTable();
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Elenco Sedi", 14, 15);
      const filtered = filterRows();
      if(filtered.length === 0) {
        alert("Nessun dato da esportare.");
        return;
      }
      const pdfData = filtered.map(row => {
        let emailKey = row.email.trim().toUpperCase();
        let emailFull = emailMap[emailKey] || row.email;
        return {
          "CittÃ ": row.citta,
          "Indirizzo": row.indirizzo,
          "Servizio ASST": row.servizio,
          "Email": emailFull,
          "Presidio Fleet": row.presidio,
          "Note": row.note
        };
      });
      const headers = ["CittÃ ", "Indirizzo", "Servizio ASST", "Email", "Presidio Fleet", "Note"];
      doc.autoTable({
        head: [headers],
        body: pdfData.map(row => headers.map(h => row[h] || "")),
        startY: 25,
        styles: { fontSize: 8 }
      });
      doc.save("elenco_sedi.pdf");
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    // Event listeners filtri
    document.getElementById('cityFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
    document.getElementById('serviceFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
    document.getElementById('presidioFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });

    // Carica CSV al caricamento pagina
    loadCSV();
  </script>
</body>
</html>